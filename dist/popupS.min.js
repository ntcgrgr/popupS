(function(root,factory){if(typeof define==="function"&&define.amd){define(factory)}else if(typeof exports==="object"){module.exports=factory()}else{root.popupS=factory()}})(this,function(){"use strict";var isOpen=false,queue=[];var R_IMG=new RegExp(/([^\/\\]+)\.(jpg|jpeg|png|gif)$/i);var _defaults={additionalBaseClass:"",additionalButtonHolderClass:"",additionalButtonOkClass:"",additionalButtonCancelClass:"",additionalCloseBtnClass:"",additionalFormClass:"",additionalOverlayClass:"",additionalPopupClass:"",additionalBtnDividerClass:"",appendLocation:document.body||document.documentElement,baseClassName:"popupS",closeBtn:"&times;",flagBodyScroll:false,flagButtonReverse:false,flagCloseByEsc:true,flagCloseByOverlay:true,flagShowCloseBtn:true,labelOk:"OK",btnOk:null,labelCancel:"Cancel",btnCancel:null,showBtnDivider:false,loader:"spinner",zIndex:1e4};var transition=function(){var t,type;var supported=false;var el=document.createElement("fakeelement");var transitions={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"otransitionend",transition:"transitionend"};for(t in transitions){if(transitions.hasOwnProperty(t)&&el.style[t]!==undefined){type=transitions[t];supported=true;break}}return{type:type,supported:supported}}();function PopupS(){}PopupS.prototype={constructor:PopupS,_open:function(options){if(typeof options.mode!=="string")throw new Error("mode must be a string");if(typeof options.title!=="undefined"&&typeof options.title!=="string")throw new Error("title must be a string");if(typeof options.placeholder!=="undefined"&&typeof options.placeholder!=="string")throw new Error("placeholder must be a string");this.options=options=_extend({},options);for(var name in _defaults){!(name in options)&&(options[name]=_defaults[name])}_each(["additionalBaseClass","additionalButtonHolderClass","additionalButtonOkClass","additionalButtonCancelClass","additionalCloseBtnClass","additionalFormClass","additionalOverlayClass","additionalPopupClass","additionalBtnDividerClass"],function(option){var string=options[option].split(" ").join(".");options[option]="."+string});for(var fn in this){if(fn.charAt(0)==="_"){this[fn]=_bind(this,this[fn])}}this._init();if(options.force===true){while(queue.length>0)queue.pop()}queue.push(options);if(!isOpen||options.force===true)this._create()},_init:function(){if(this.$layerEl&&this.$layerEl.style.opacity)this.$layerEl.style.opacity="";if(!this.$wrapEl){this.$wrapEl=_buildDOM({tag:"div."+this.options.baseClassName+"-base"+(this.options.additionalBaseClass?this.options.additionalBaseClass:""),css:{top:0,left:0,right:0,bottom:0,position:"fixed",textAlign:"center",overflowX:"auto",overflowY:"auto",outline:0,whiteSpace:"nowrap",zIndex:this.options.zIndex},children:{css:{height:"100%",display:"inline-block",verticalAlign:"middle"}}});_appendChild(this.$wrapEl,this._getOverlay());_appendChild(this.$wrapEl,this._getLayer())}},_getOverlay:function(){if(!this.$overlayEl){this.$overlayEl=_buildDOM({tag:"#popupS-overlay."+this.options.baseClassName+"-overlay"+(this.options.additionalOverlayClass?this.options.additionalOverlayClass:""),css:{top:0,right:0,bottom:0,left:0,position:"fixed",overflowX:"hidden",userSelect:"none",webkitUserSelect:"none",MozUserSelect:"none"}})}this.$overlayEl.setAttribute("unselectable","on");return this.$overlayEl},_getLayer:function(){if(!this.$layerEl){this.$layerEl=_buildDOM({css:{display:"inline-block",position:"relative",textAlign:"left",whiteSpace:"normal",verticalAlign:"middle",maxWidth:"100%",overflowX:"hidden",transform:"translate3d(0,0,0)"},children:{tag:"."+this.options.baseClassName+"-layer"+(this.options.additionalPopupClass?this.options.additionalPopupClass:"")}})}return this.$layerEl},_resetLayer:function(){this.$layerEl.childNodes[0].innerHTML=""},_create:function(){var self=this;var item=queue[0];var mode=item.mode;isOpen=true;if(mode!="modal-ajax"){this._createPopup(item)}else{this._loadContents(item)}var transitionDone=function(event){event.stopPropagation();_unbind(self.$layerEl,transition.type,transitionDone)};if(transition.supported){_bind(self.$layerEl,transition.type,transitionDone)}},_createPopup:function(item){var btnOk,btnCancel,btnDivider,htmlObj;var mode=item.mode;var title=item.title;var content=item.content;var className=item.className?"."+item.className:"";var contentObj=content instanceof Object?true:false;this.callbacks={onOpen:item.onOpen,onSubmit:item.onSubmit,onClose:item.onClose};btnOk={tag:"button#popupS-button-ok."+this.options.baseClassName+"-button-ok"+(this.options.additionalButtonOkClass?this.options.additionalButtonOkClass:""),text:this.options.labelOk,html:this.options.btnOk};btnCancel={tag:"button#popupS-button-cancel."+this.options.baseClassName+"-button-ok"+(this.options.additionalButtonCancelClass?this.options.additionalButtonCancelClass:""),text:this.options.labelCancel,html:this.options.btnCancel};btnDivider={tag:"div#popupS-button-divider."+this.options.baseClassName+"-button-divider"+this.options.additionalBtnDividerClass};var buttonGroup=this.options.showBtnDivider?[btnOk,btnDivider,btnCancel]:[btnOk,btnCancel];htmlObj=[{html:content},mode!="modal"&&mode!="modal-ajax"&&mode=="prompt"&&{tag:"form."+this.options.baseClassName+"-form"+(this.options.additionalFormClass?this.options.additionalFormClass:""),children:[item.placeholder&&{tag:"label",htmlFor:"popupS-input",text:item.placeholder},{tag:"input#popupS-input",type:"text"}]},mode!="modal"&&mode!="modal-ajax"&&{tag:"nav."+this.options.baseClassName+"-buttons"+(this.options.additionalButtonHolderClass?this.options.additionalButtonHolderClass:""),children:mode=="prompt"||mode=="confirm"?!this.options.flagButtonReverse?buttonGroup.reverse():buttonGroup:[btnOk]}];content=_buildDOM({children:[{tag:"a#popupS-resetFocusBack."+this.options.baseClassName+"-resetFocus",href:"#",text:"Reset Focus"},this.options.flagShowCloseBtn&&{tag:"span#popupS-close."+this.options.baseClassName+"-close"+(this.options.additionalCloseBtnClass?this.options.additionalCloseBtnClass:""),html:this.options.closeBtn},title&&{tag:"h5."+this.options.baseClassName+"-title"+className,text:title},{tag:"."+this.options.baseClassName+"-content"+className,children:contentObj&&content||htmlObj},{tag:"a#popupS-resetFocus."+this.options.baseClassName+"-resetFocus",href:"#",text:"Reset Focus"}]});this._resetLayer();_appendChild(this.$layerEl.childNodes[0],content);this._appendPopup();this.$contentEl=this.$layerEl.getElementsByClassName(this.options.baseClassName+"-content")[0];this.$btnReset=document.getElementById("popupS-resetFocus");this.$btnResetBack=document.getElementById("popupS-resetFocusBack");_on(this.$btnReset,"focus",this._resetEvent);_on(this.$btnResetBack,"focus",this._resetEvent);_autoFocus(this.$layerEl);this.$btnOK=document.getElementById("popupS-button-ok")||undefined;this.$btnCancel=document.getElementById("popupS-button-cancel")||undefined;this.$input=document.getElementById("popupS-input")||undefined;if(typeof this.$btnOK!=="undefined")_on(this.$btnOK,"click",this._okEvent);if(typeof this.$btnCancel!=="undefined")_on(this.$btnCancel,"click",this._cancelEvent);if(this.options.flagShowCloseBtn)_on(document.getElementById("popupS-close"),"click",this._cancelEvent);if(this.options.flagCloseByOverlay)_on(this.$overlayEl,"click",this._cancelEvent);if(this.options.flagCloseByEsc)_on(document.body,"keyup",this._keyEvent);if(typeof this.callbacks.onOpen==="function")this.callbacks.onOpen.call(this)},_appendPopup:function(){this.$targetEl=this.options.appendLocation;_appendChild(this.$targetEl,this.$wrapEl);if(this.$targetEl===(document.body||document.documentElement)&&this.options.flagBodyScroll===false){_css(this.$targetEl,{overflow:"hidden"})}if(window.getComputedStyle)window.getComputedStyle(this.$wrapEl,null).height;var classReg=function(className){return new RegExp("(|\\s+)"+className+"(\\s+|$)")};if(!classReg(" "+this.options.baseClassName+"-open").test(this.$wrapEl.className)){this.$wrapEl.className+=" "+this.options.baseClassName+"-open"}if(!classReg(" "+this.options.baseClassName+"-open").test(this.$layerEl.childNodes[0].className)){this.$layerEl.childNodes[0].className+=" "+this.options.baseClassName+"-open"}},_hide:function(){var self=this;queue.splice(0,1);if(queue.length>0)this._create();else{isOpen=false;var removeWrap=function(){_removeElement(self.$wrapEl);if(self.$targetEl===(document.body||document.documentElement)&&self.options.flagBodyScroll===false){if(self.$targetEl.style.removeProperty){self.$targetEl.style.removeProperty("overflow")}else{self.$targetEl.style.removeAttribute("overflow")}}};var transitionDone=function(event){event.stopPropagation();_off(self.$wrapEl,transition.type,transitionDone);removeWrap()};var transitionDoneLayer=function(event){event.stopPropagation();_off(self.$layerEl,transition.type,transitionDone)};this.$wrapEl.className=this.$wrapEl.className.replace(" "+this.options.baseClassName+"-open","");if(transition.supported){_on(self.$wrapEl,transition.type,transitionDone)}else{removeWrap()}this.$layerEl.childNodes[0].className=this.$layerEl.childNodes[0].className.replace(" "+this.options.baseClassName+"-open","");if(transition.supported)_on(self.$layerEl,transition.type,transitionDoneLayer)}},_loading:function(state){this.$loadingEl=_buildDOM({tag:"div."+this.options.baseClassName+"-loading."+this.options.loader});if(state){this._resetLayer();_css(this.$layerEl.childNodes[0],{height:"60px",width:"60px",borderRadius:"30px"});_appendChild(this.$layerEl.childNodes[0],this.$loadingEl);this._appendPopup()}else{_css(this.$layerEl.childNodes[0],{height:null,width:null,borderRadius:null})}},_loadContents:function(item){var url=item.ajax.url,str=typeof item.ajax.str!="undefined"?item.ajax.str:"",post=typeof item.ajax.post!="undefined"?item.ajax.post:true,self=this;if(url.match(R_IMG)){var imgElement=_buildDOM({children:{tag:"img",src:url}});this._loading(true);this._preLoadImage(imgElement,function(){self._loading(false);item.content=imgElement;self._createPopup(item)})}else{this._ajax(url,str,post,function(e){var ajaxElement=_buildDOM({html:this});self._preLoadImage(ajaxElement,function(){self._loading(false);item.content=ajaxElement;self._createPopup(item)})},function(){self._loading(true)})}},_preLoadImage:function(parentNode,callback){var items=_getElementsByTagName(parentNode,"img");var i=items.length;var queue=i;var img;var self=this;while(i--){img=items[i];if(img.complete){queue--}else{_on(img,"load",complete);_on(img,"error",complete)}}!queue&&complete();var complete=function(){if(--queue<=0){i=items.length;while(i--){img=items[i];_off(img,"load",complete);_off(img,"error",complete)}callback()}}},_ajax:function(filename,str,post,callback,beforeSend){var ajax;if(window.XMLHttpRequest){ajax=new XMLHttpRequest}else if(ActiveXObject("Microsoft.XMLHTTP")){ajax=new ActiveXObject("Microsoft.XMLHTTP")}else if(ActiveXObject("Msxml2.XMLHTTP")){ajax=new ActiveXObject("Msxml2.XMLHTTP")}else{alert("Error: Your browser does not support AJAX.");return false}ajax.onreadystatechange=function(){if(ajax.readyState==4&&ajax.status==200){if(callback)callback.call(ajax.responseText)}};if(post===false){ajax.open("GET",filename+str,true);ajax.send(null)}else{ajax.open("POST",filename,true);ajax.setRequestHeader("Content-type","application/x-www-form-urlencoded");ajax.send(str)}if(beforeSend)beforeSend.call();return ajax},_okEvent:function(event){if(typeof event.preventDefault!=="undefined")event.preventDefault();if(typeof this.callbacks.onSubmit==="function"){if(typeof this.$input!=="undefined"){this.callbacks.onSubmit.call(this,this.$input.value)}else{this.callbacks.onSubmit.call(this)}}this._commonEvent()},_cancelEvent:function(event){if(typeof event.preventDefault!=="undefined")event.preventDefault();if(typeof this.callbacks.onClose==="function"){this.callbacks.onClose.call(this)}this._commonEvent()},_commonEvent:function(){if(typeof this.$btnOK!=="undefined")_off(this.$btnOK,"click",this._okEvent);if(typeof this.$btnCancel!=="undefined")_off(this.$btnCancel,"click",this._cancelEvent);if(this.options.flagShowCloseBtn)_off(document.getElementById("popupS-close"),"click",this._cancelEvent);if(this.options.flagCloseByOverlay)_off(this.$overlayEl,"click",this._cancelEvent);if(this.options.flagCloseByEsc)_off(document.body,"keyup",this._keyEvent);this._hide()},_resetEvent:function(event){_autoFocus(this.$layerEl)},_keyEvent:function(event){var keyCode=event.keyCode;if(typeof this.$input!=="undefined"&&keyCode===13)this._okEvent(event);if(keyCode===27)this._cancelEvent(event)}};function _bind(ctx,fn){var args=[].slice.call(arguments,2);return fn.bind?fn.bind.apply(fn,[ctx].concat(args)):function(){return fn.apply(ctx,args.concat([].slice.call(arguments)))}}function _each(obj,iterator){if(obj){for(var key in obj){if(obj.hasOwnProperty(key)){iterator(obj[key],key,obj)}}}}function _extend(out){out=out||{};for(var i=1;i<arguments.length;i++){if(!arguments[i])continue;for(var key in arguments[i]){if(arguments[i].hasOwnProperty(key))out[key]=arguments[i][key]}}return out}function _on(el,event,fn){if(typeof el.addEventListener==="function"){el.addEventListener(event,fn,false)}else if(el.attachEvent){el.attachEvent("on"+event,fn)}}function _off(el,event,fn){if(typeof el.removeEventListener==="function"){el.removeEventListener(event,fn,false)}else if(el.detachEvent){el.detachEvent("on"+event,fn)}}function _css(el,prop,val){if(el&&el.style&&prop){if(prop instanceof Object){for(var name in prop){_css(el,name,prop[name])}}else{el.style[prop]=val}}}var R_SELECTOR=/^(\w+)?(#[\w_-]+)?((?:\.[\w_-]+)*)/i;function _buildDOM(spec){if(spec===null){spec="div"}if(typeof spec==="string"){spec={tag:spec}}var el,classSelector;var fragment=document.createDocumentFragment();var children=spec.children;var selector=R_SELECTOR.exec(spec.tag||"");delete spec.children;spec.tag=selector[1]||"div";spec.id=spec.id||(selector[2]||"").substr(1);classSelector=(selector[3]||"").split(".");classSelector[0]=spec.className||"";spec.className=classSelector.join(" ");el=document.createElement(spec.tag);_appendChild(fragment,el);delete spec.tag;_each(spec,function(value,key){if(key==="css"){_css(el,spec.css)}else if(key==="text"){value!==null&&_appendChild(el,document.createTextNode(value))}else if(key==="html"){value!==null&&(el.innerHTML=value)}else if(key in el){try{el[key]=value}catch(e){el.setAttribute(key,value)}}else if(/^data-/.test(key)){el.setAttribute(key,value)}});if(children&&children.appendChild){_appendChild(el,children)}else if(children){if(children instanceof Array){_each(children,function(value,key){if(value instanceof Object){_appendChild(el,_buildDOM(value))}})}else if(children instanceof Object){_appendChild(el,_buildDOM(children))}}return el}function _appendChild(parent,el){try{parent&&el&&parent.appendChild(el)}catch(e){}}function _autoFocus(parentNode){var items=_getElementsByTagName(parentNode,"input");var i=0;var n=items.length;var el,element;for(;i<n;i++){el=items[i];if(el.type==="submit"){!element&&(element=el)}else if(!/hidden|check|radio/.test(el.type)&&el.value===""){element=el;break}}if(!element){element=_getElementsByTagName(parentNode,"button")[0]}try{element.focus()}catch(err){}}function _getElementsByTagName(el,name){return el.getElementsByTagName(name)}function _removeElement(el){if(el&&el.parentNode){el.parentNode.removeChild(el)}}var popupS=new PopupS;popupS.window=function(params){this._open(params)};popupS.alert=function(params){params=_extend(params,{mode:"alert"});this._open(params)};popupS.confirm=function(params){params=_extend(params,{mode:"confirm"});this._open(params)};popupS.prompt=function(params){params=_extend(params,{mode:"prompt"});this._open(params)};popupS.modal=function(params){params=_extend(params,{mode:"modal"});this._open(params)};popupS.ajax=function(params){params=_extend(params,{mode:"modal-ajax"});this._open(params)};return popupS});